import os
import pytest
from typer.testing import CliRunner
from jtc.cli.main import app

runner = CliRunner()

@pytest.fixture(autouse=True)
def cleanup_files():
    """Clean up generated files after each test."""
    yield
    # List of possible files generated by tests
    files = [
        "workbench/app/models/test_model.py",
        "workbench/app/repositories/test_repository.py",
        "workbench/http/controllers/test_controller.py",
        "workbench/app/providers/test_service_provider.py",
        "workbench/app/models/force_model.py",
    ]
    for f in files:
        if os.path.exists(f):
            os.remove(f)

def test_make_model():
    # Correct Syntax: ["make", "model"] instead of ["make:model"]
    result = runner.invoke(app, ["make", "model", "TestModel"])
    assert result.exit_code == 0
    assert "Model created" in result.stdout
    assert os.path.exists("workbench/app/models/test_model.py")

def test_make_repository():
    result = runner.invoke(app, ["make", "repository", "TestRepository"])
    assert result.exit_code == 0
    assert "Repository created" in result.stdout
    assert os.path.exists("workbench/app/repositories/test_repository.py")

def test_make_controller():
    result = runner.invoke(app, ["make", "controller", "TestController"])
    assert result.exit_code == 0
    assert "Controller created" in result.stdout
    assert os.path.exists("workbench/http/controllers/test_controller.py")

def test_make_provider():
    result = runner.invoke(app, ["make", "provider", "TestServiceProvider"])
    assert result.exit_code == 0
    assert "Provider created" in result.stdout
    assert os.path.exists("workbench/app/providers/test_service_provider.py")

def test_make_existing_file_fails_without_force():
    # 1. Create file first
    runner.invoke(app, ["make", "model", "ForceModel"])
    
    # 2. Try to create again (should fail)
    result = runner.invoke(app, ["make", "model", "ForceModel"])
    assert result.exit_code == 1
    assert "File already exists" in result.stdout

def test_make_force_overwrites():
    # 1. Create file first
    runner.invoke(app, ["make", "model", "ForceModel"])
    
    # 2. Force overwrite (should succeed)
    result = runner.invoke(app, ["make", "model", "ForceModel", "--force"])
    assert result.exit_code == 0
    assert "Model created" in result.stdout
