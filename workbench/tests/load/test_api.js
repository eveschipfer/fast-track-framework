/**
 * test_api Load Test
 *
 * k6 load testing script for Test Api.
 * Generated by Fast Track Framework CLI.
 *
 * Usage:
 *   k6 run workbench/tests/load/test_api.js
 *
 *   Or with custom VUs and duration:
 *   k6 run --vus 50 --duration 1m workbench/tests/load/test_api.js
 *
 * Documentation: https://k6.io/docs/
 */

import http from "k6/http";
import { check, sleep } from "k6";

// Load test configuration
export const options = {
    // Stages for ramping up/down load
    stages: [
        // Ramp up to 10 VUs over 10 seconds
        { duration: "10s", target: 10 },
        // Stay at 10 VUs for 30s
        { duration: "30s", target: 10 },
        // Ramp down to 0 VUs over 10 seconds
        { duration: "10s", target: 0 },
    ],

    // Performance thresholds
    // Test fails if these thresholds are breached
    thresholds: {
        // 95th percentile response time must be under 500ms
        http_req_duration: ["p(95)<500"],

        // Error rate must be under 1%
        http_req_failed: ["rate<0.01"],

        // Request rate must be at least 10 requests per second
        http_reqs: ["rate>=10"],
    },
};

// Base URL for API (can be overridden with environment variable)
const BASE_URL = __ENV.BASE_URL || "http://localhost:8000";

export default function () {
    // Make HTTP request to your API endpoint
    const response = http.get(`${BASE_URL}/api/endpoint`);

    // Validate response
    check(response, {
        "Status is 200": (r) => r.status === 200,
        "Response time < 500ms": (r) => r.timings.duration < 500,
        "Response body is not empty": (r) => r.json() !== null,
    });

    // Pause between iterations (random sleep between 1-3 seconds)
    sleep(Math.random() * 2 + 1);
}
