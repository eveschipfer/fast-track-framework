"""
UserResource - API Resource

This resource transforms User models into JSON responses.
Generated by Fast Track Framework CLI.

Usage:
------
Single resource:
    UserResource.make(user).resolve()
    # Returns: {"data": {"id": 1, ...}}

Collection:
    UserResource.collection(users).resolve()
    # Returns: {"data": [{...}, {...}]}

Educational Note:
----------------
API Resources decouple your database schema from your API response format.
This allows you to:
- Rename fields (user_id -> userId for camelCase APIs)
- Format data (datetime -> ISO 8601 string)
- Hide sensitive fields (password, tokens)
- Add computed fields (full_name from first_name + last_name)
- Control relationships (only include when eager-loaded)
- Conditional fields (based on permissions)
"""

from typing import Any

from ftf.resources import JsonResource, MISSING

try:
    from fastapi import Request
except ImportError:
    Request = None  # type: ignore

from app.models.user import User


class UserResource(JsonResource[User]):
    """
    Transform User model to API response.

    This resource controls exactly what data is exposed in your API
    and how it's formatted.
    """

    def to_array(self, request: Request | None = None) -> dict[str, Any]:
        """
        Transform User to dictionary.

        Args:
            request: Optional FastAPI request for conditional logic

        Returns:
            Dictionary representation of the User

        Example:
            {
                "id": 1,
                "name": "...",
                # Add more fields here
            }
        """
        return {
            "id": self.resource.id,
            # TODO: Add more fields here

            # Example: Format datetime
            # "created_at": self.resource.created_at.isoformat(),

            # Example: Conditional field (only for admins)
            # "email": self.when(is_admin(request), self.resource.email),

            # Example: Computed field
            # "full_name": f"{self.resource.first_name} {self.resource.last_name}",

            # Example: Nested resource
            # "user": UserResource.make(self.resource.user).to_array(request)
            #         if self.when_loaded("user") is not MISSING
            #         else MISSING,
        }


# Usage Examples:
# ---------------
#
# In a route/controller:
#
# @app.get("/api/users/{id}")
# async def get_user(
#     id: int,
#     repo: UserRepository = Inject(UserRepository)
# ):
#     user = await repo.find_or_fail(id)
#     return UserResource.make(user).resolve()
#
# @app.get("/api/users")
# async def list_users(
#     repo: UserRepository = Inject(UserRepository)
# ):
#     users = await repo.all()
#     return UserResource.collection(users).resolve()
